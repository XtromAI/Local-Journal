<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Growth Journal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            line-height: 1.6;
            height: 100vh;
            overflow: hidden;
        }

        #app {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .view {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .view.active {
            display: flex;
        }

        /* Header Styles */
        header {
            background-color: #2d2d2d;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #404040;
            flex-shrink: 0;
        }

        h1 {
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
        }

        /* Button Styles */
        button {
            background-color: #4a9eff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 44px; /* Touch-friendly */
        }

        button:hover {
            background-color: #3a8eef;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background-color: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Chat Container */
        #chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }

        #messages {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding-bottom: 1rem;
        }

        /* Message Styles */
        .message {
            max-width: 85%;
            padding: 0.875rem 1.125rem;
            border-radius: 18px;
            font-size: 0.95rem;
            line-height: 1.4;
            word-wrap: break-word;
        }

        .message.user {
            background-color: #4a9eff;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }

        .message.ai {
            background-color: #333333;
            color: #e0e0e0;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #404040;
        }

        .message.system {
            background-color: #2d4a2d;
            color: #90ee90;
            align-self: center;
            text-align: center;
            font-style: italic;
            border-radius: 12px;
            max-width: 90%;
        }

        .message.error {
            background-color: #4a2d2d;
            color: #ff9090;
            align-self: center;
            text-align: center;
            border-radius: 12px;
            max-width: 90%;
        }

        /* Input Section */
        #input-section {
            background-color: #2d2d2d;
            padding: 1rem;
            border-top: 1px solid #404040;
            flex-shrink: 0;
        }

        #message-input {
            width: 100%;
            background-color: #1a1a1a;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 0.875rem;
            color: #e0e0e0;
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            min-height: 44px;
            max-height: 120px;
            margin-bottom: 0.75rem;
        }

        #message-input:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        #message-input::placeholder {
            color: #888;
        }

        #button-container {
            display: flex;
            gap: 0.75rem;
            justify-content: space-between;
        }

        #button-container button {
            flex: 1;
        }

        #finish-entry-btn {
            background-color: #28a745;
        }

        #finish-entry-btn:hover {
            background-color: #218838;
        }

        /* Entries View */
        #entries-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        #entries-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .entry-item {
            background-color: #2d2d2d;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .entry-item:hover {
            background-color: #333333;
            border-color: #4a9eff;
        }

        .entry-item:active {
            transform: scale(0.98);
        }

        .entry-date {
            font-size: 0.8rem;
            color: #888;
            margin-bottom: 0.5rem;
        }

        .entry-summary {
            font-size: 0.9rem;
            color: #e0e0e0;
            line-height: 1.4;
        }

        .entry-status {
            font-size: 0.75rem;
            color: #4a9eff;
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .entry-status.finished {
            color: #28a745;
        }

        /* Entry Detail View */
        #entry-detail-container {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        #entry-detail-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .detail-summary {
            background-color: #2d4a2d;
            color: #90ee90;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .detail-summary h3 {
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            position: relative;
            width: 20px;
            height: 20px;
        }

        .loading:after {
            content: " ";
            display: block;
            width: 16px;
            height: 16px;
            margin: 2px;
            border-radius: 50%;
            border: 2px solid #4a9eff;
            border-color: #4a9eff transparent #4a9eff transparent;
            animation: loading 1.2s linear infinite;
        }

        @keyframes loading {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #888;
        }

        .empty-state h3 {
            margin-bottom: 0.5rem;
            color: #e0e0e0;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            header {
                padding: 0.75rem;
            }

            h1 {
                font-size: 1.1rem;
            }

            button {
                padding: 0.625rem 1.25rem;
                font-size: 0.85rem;
            }

            #chat-container, #entries-container, #entry-detail-container {
                padding: 0.75rem;
            }

            .message {
                font-size: 0.9rem;
                padding: 0.75rem 1rem;
            }

            #message-input {
                font-size: 0.9rem;
                padding: 0.75rem;
            }

            #button-container {
                gap: 0.5rem;
            }
        }

        /* Scrollbar Styles */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #404040;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a9eff;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Chat View -->
        <div id="chat-view" class="view active">
            <header>
                <h1>Personal Growth Journal</h1>
                <button id="view-entries-btn">View Entries</button>
            </header>
            
            <div id="chat-container">
                <div id="messages"></div>
            </div>
            
            <div id="input-section">
                <textarea id="message-input" placeholder="Share what's on your mind..."></textarea>
                <div id="button-container">
                    <button id="go-deeper-btn">Go Deeper</button>
                    <button id="finish-entry-btn">Finish Entry</button>
                </div>
            </div>
        </div>
        
        <!-- Journal Entries View -->
        <div id="entries-view" class="view">
            <header>
                <h1>Journal Entries</h1>
                <button id="new-chat-btn">New Chat</button>
            </header>
            
            <div id="entries-container">
                <div id="entries-list"></div>
            </div>
        </div>
        
        <!-- Entry Detail View -->
        <div id="entry-detail-view" class="view">
            <header>
                <button id="back-to-entries-btn">‚Üê Back</button>
                <h1>Entry Detail</h1>
            </header>
            
            <div id="entry-detail-container">
                <div id="entry-detail-content"></div>
            </div>
        </div>
    </div>

    <script>
        // API Configuration
        const GEMINI_API_KEY = 'YOUR_GEMINI_API_KEY_HERE'; // Replace with your actual API key
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
        
        // Application State
        let currentConversation = [];
        let conversations = [];
        let currentView = 'chat';
        let isFinishingEntry = false;
        let currentEntryId = null;

        // AI Persona Prompt
        const SYSTEM_PROMPT = `You are a supportive AI guide with expertise in Cognitive Behavioral Therapy (CBT). Your role is to help users explore their thoughts and feelings through thoughtful questions and reflections. 

        Guidelines:
        - Be warm, empathetic, and non-judgmental
        - Ask open-ended questions that encourage deeper reflection
        - Help users identify patterns in their thinking and emotions
        - Offer gentle CBT-based insights when appropriate
        - Keep responses conversational and supportive
        - Avoid giving direct advice; instead, guide users to their own insights
        - When asked to summarize, provide a brief, insightful summary of the conversation's key themes

        Remember: You're here to listen, guide, and help users discover their own wisdom.`;

        // DOM Elements
        const chatView = document.getElementById('chat-view');
        const entriesView = document.getElementById('entries-view');
        const entryDetailView = document.getElementById('entry-detail-view');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const goDeeperBtn = document.getElementById('go-deeper-btn');
        const finishEntryBtn = document.getElementById('finish-entry-btn');
        const viewEntriesBtn = document.getElementById('view-entries-btn');
        const newChatBtn = document.getElementById('new-chat-btn');
        const backToEntriesBtn = document.getElementById('back-to-entries-btn');
        const entriesList = document.getElementById('entries-list');
        const entryDetailContent = document.getElementById('entry-detail-content');

        // Initialize Application
        function init() {
            loadConversations();
            setupEventListeners();
            showView('chat');
            
            if (conversations.length === 0) {
                startNewConversation();
            } else {
                loadCurrentConversation();
            }
        }

        // Event Listeners
        function setupEventListeners() {
            goDeeperBtn.addEventListener('click', handleGoDeeper);
            finishEntryBtn.addEventListener('click', handleFinishEntry);
            viewEntriesBtn.addEventListener('click', () => showView('entries'));
            newChatBtn.addEventListener('click', startNewConversation);
            backToEntriesBtn.addEventListener('click', () => showView('entries'));
            
            messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    handleGoDeeper();
                }
            });

            messageInput.addEventListener('input', () => {
                const hasText = messageInput.value.trim().length > 0;
                goDeeperBtn.disabled = !hasText || isFinishingEntry;
                finishEntryBtn.disabled = currentConversation.length === 0 || isFinishingEntry;
            });
        }

        // Data Management
        function saveConversations() {
            localStorage.setItem('journal_conversations', JSON.stringify(conversations));
        }

        function loadConversations() {
            const stored = localStorage.getItem('journal_conversations');
            conversations = stored ? JSON.parse(stored) : [];
        }

        function createConversation() {
            return {
                id: Date.now().toString(),
                createdAt: new Date().toISOString(),
                messages: [],
                summary: null,
                isFinished: false
            };
        }

        function saveCurrentConversation() {
            if (currentEntryId) {
                const conversation = conversations.find(c => c.id === currentEntryId);
                if (conversation) {
                    conversation.messages = [...currentConversation];
                    saveConversations();
                }
            }
        }

        function loadCurrentConversation() {
            const unfinishedConversation = conversations.find(c => !c.isFinished);
            if (unfinishedConversation) {
                currentEntryId = unfinishedConversation.id;
                currentConversation = [...unfinishedConversation.messages];
                renderMessages();
            } else {
                startNewConversation();
            }
        }

        // View Management
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
            
            if (viewName === 'chat') {
                chatView.classList.add('active');
                currentView = 'chat';
                messageInput.focus();
            } else if (viewName === 'entries') {
                entriesView.classList.add('active');
                currentView = 'entries';
                renderEntriesList();
            } else if (viewName === 'entry-detail') {
                entryDetailView.classList.add('active');
                currentView = 'entry-detail';
            }
        }

        // Message Handling
        function addMessage(content, type = 'user') {
            const message = {
                content,
                type,
                timestamp: new Date().toISOString()
            };
            currentConversation.push(message);
            renderMessages();
            saveCurrentConversation();
        }

        function renderMessages() {
            messagesContainer.innerHTML = '';
            
            currentConversation.forEach(message => {
                const messageEl = document.createElement('div');
                messageEl.className = `message ${message.type}`;
                messageEl.textContent = message.content;
                messagesContainer.appendChild(messageEl);
            });

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Update button states
            const hasText = messageInput.value.trim().length > 0;
            goDeeperBtn.disabled = !hasText || isFinishingEntry;
            finishEntryBtn.disabled = currentConversation.length === 0 || isFinishingEntry;
        }

        function showLoadingMessage() {
            const loadingEl = document.createElement('div');
            loadingEl.className = 'message ai';
            loadingEl.innerHTML = '<div class="loading"></div>';
            messagesContainer.appendChild(loadingEl);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            return loadingEl;
        }

        // API Communication
        async function callGeminiAPI(userMessage, isForSummary = false) {
            if (!GEMINI_API_KEY || GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE') {
                throw new Error('Please set your Gemini API key in the script section.');
            }

            let prompt = SYSTEM_PROMPT + "\n\n";
            
            if (isForSummary) {
                prompt += "Please provide a brief, insightful summary of this conversation, highlighting the key themes and insights that emerged:\n\n";
                currentConversation.forEach(msg => {
                    if (msg.type === 'user' || msg.type === 'ai') {
                        prompt += `${msg.type === 'user' ? 'User' : 'AI'}: ${msg.content}\n`;
                    }
                });
                prompt += "\nSummary:";
            } else {
                // Add conversation history for context
                currentConversation.forEach(msg => {
                    if (msg.type === 'user' || msg.type === 'ai') {
                        prompt += `${msg.type === 'user' ? 'User' : 'AI'}: ${msg.content}\n`;
                    }
                });
                prompt += `User: ${userMessage}\nAI:`;
            }

            const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: prompt
                        }]
                    }],
                    generationConfig: {
                        temperature: 0.7,
                        topK: 40,
                        topP: 0.8,
                        maxOutputTokens: 1024,
                    },
                    safetySettings: [
                        {
                            category: "HARM_CATEGORY_HARASSMENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_HATE_SPEECH",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        },
                        {
                            category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                            threshold: "BLOCK_MEDIUM_AND_ABOVE"
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => null);
                if (response.status === 400 && errorData?.error?.message?.includes('API key')) {
                    throw new Error('Invalid API key. Please check your Gemini API key.');
                }
                throw new Error(`API request failed: ${response.status} ${response.statusText}`);
            }

            const data = await response.json();
            
            if (!data.candidates || data.candidates.length === 0) {
                throw new Error('No response generated from AI');
            }

            return data.candidates[0].content.parts[0].text;
        }

        // Conversation Actions
        async function handleGoDeeper() {
            const userMessage = messageInput.value.trim();
            if (!userMessage || isFinishingEntry) return;

            messageInput.value = '';
            goDeeperBtn.disabled = true;
            finishEntryBtn.disabled = true;

            addMessage(userMessage, 'user');

            const loadingEl = showLoadingMessage();

            try {
                const aiResponse = await callGeminiAPI(userMessage);
                messagesContainer.removeChild(loadingEl);
                addMessage(aiResponse, 'ai');
            } catch (error) {
                messagesContainer.removeChild(loadingEl);
                addMessage(`Error: ${error.message}`, 'error');
            }

            goDeeperBtn.disabled = false;
            finishEntryBtn.disabled = false;
            messageInput.focus();
        }

        async function handleFinishEntry() {
            if (currentConversation.length === 0 || isFinishingEntry) return;

            isFinishingEntry = true;
            goDeeperBtn.disabled = true;
            finishEntryBtn.disabled = true;

            addMessage('Finishing entry...', 'system');
            const loadingEl = showLoadingMessage();

            try {
                const summary = await callGeminiAPI('', true);
                messagesContainer.removeChild(loadingEl);
                addMessage(`Entry Summary: ${summary}`, 'system');

                // Mark conversation as finished
                const conversation = conversations.find(c => c.id === currentEntryId);
                if (conversation) {
                    conversation.summary = summary;
                    conversation.isFinished = true;
                    conversation.finishedAt = new Date().toISOString();
                    saveConversations();
                }

                // Start a new conversation after a delay
                setTimeout(() => {
                    startNewConversation();
                }, 2000);

            } catch (error) {
                messagesContainer.removeChild(loadingEl);
                addMessage(`Error generating summary: ${error.message}`, 'error');
                isFinishingEntry = false;
                goDeeperBtn.disabled = false;
                finishEntryBtn.disabled = false;
            }
        }

        function startNewConversation() {
            const newConversation = createConversation();
            conversations.push(newConversation);
            saveConversations();

            currentEntryId = newConversation.id;
            currentConversation = [];
            isFinishingEntry = false;

            renderMessages();
            showView('chat');

            // Add welcome message
            addMessage("Welcome to your personal growth journal. What's on your mind today?", 'ai');
            
            messageInput.focus();
        }

        // Entries Management
        function renderEntriesList() {
            entriesList.innerHTML = '';

            const finishedEntries = conversations.filter(c => c.isFinished);
            const unfinishedEntries = conversations.filter(c => !c.isFinished);

            if (finishedEntries.length === 0 && unfinishedEntries.length === 0) {
                entriesList.innerHTML = '<div class="empty-state"><h3>No entries yet</h3><p>Start your first conversation to create an entry.</p></div>';
                return;
            }

            // Show unfinished conversations first
            unfinishedEntries.forEach(conversation => {
                const entryEl = createEntryElement(conversation);
                entriesList.appendChild(entryEl);
            });

            // Then finished entries, most recent first
            finishedEntries
                .sort((a, b) => new Date(b.finishedAt || b.createdAt) - new Date(a.finishedAt || a.createdAt))
                .forEach(conversation => {
                    const entryEl = createEntryElement(conversation);
                    entriesList.appendChild(entryEl);
                });
        }

        function createEntryElement(conversation) {
            const entryEl = document.createElement('div');
            entryEl.className = 'entry-item';
            
            const date = new Date(conversation.finishedAt || conversation.createdAt);
            const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            entryEl.innerHTML = `
                <div class="entry-date">${dateStr}</div>
                <div class="entry-summary">${conversation.summary || 'Conversation in progress...'}</div>
                <div class="entry-status ${conversation.isFinished ? 'finished' : ''}">${conversation.isFinished ? 'Completed' : 'In Progress'}</div>
            `;

            entryEl.addEventListener('click', () => {
                if (conversation.isFinished) {
                    showEntryDetail(conversation);
                } else {
                    resumeConversation(conversation);
                }
            });

            return entryEl;
        }

        function showEntryDetail(conversation) {
            entryDetailContent.innerHTML = '';

            if (conversation.summary) {
                const summaryEl = document.createElement('div');
                summaryEl.className = 'detail-summary';
                summaryEl.innerHTML = `
                    <h3>Summary</h3>
                    <p>${conversation.summary}</p>
                `;
                entryDetailContent.appendChild(summaryEl);
            }

            const messagesEl = document.createElement('div');
            messagesEl.innerHTML = '<h3 style="margin-bottom: 1rem; color: #ffffff;">Conversation</h3>';
            
            conversation.messages.forEach(message => {
                if (message.type === 'user' || message.type === 'ai') {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${message.type}`;
                    messageEl.style.marginBottom = '1rem';
                    messageEl.textContent = message.content;
                    messagesEl.appendChild(messageEl);
                }
            });

            entryDetailContent.appendChild(messagesEl);
            showView('entry-detail');
        }

        function resumeConversation(conversation) {
            currentEntryId = conversation.id;
            currentConversation = [...conversation.messages];
            isFinishingEntry = false;
            
            renderMessages();
            showView('chat');
            messageInput.focus();
        }

        // Initialize the application
        init();
    </script>
</body>
</html>
